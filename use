#!/bin/bash

set -euo pipefail

STOW="./stow"
FILESDIR="files"
STOWARGS="-d ${FILESDIR} -t ${HOME}"
USERC=".userc"

# Build stow if it doesn't exist
if [[ ! -f ./stow ]]; then
	if command -v stow 2> /dev/null; then
		ln -s "$(command -v stow)" "${STOW}"
	else
		curl http://ftp.gnu.org/gnu/stow/stow-latest.tar.gz | tar -xzf -
		STOWDIR="$(find -maxdepth 1 -type d -name 'stow-*' -printf '%P\n' -quit)"
		(cd $STOWDIR && ./configure && make)
		sed stow.in -e "s/@STOWDIR@/${STOWDIR}/g" > ${STOW}
		chmod +x ${STOW}
	fi
fi

# Get all modules we want to "use"
uniques=($(echo "$@" $(cat ${USERC} 2>/dev/null)| xargs -n1| sort -u| xargs))

for cmd in ${uniques[@]}; do
	echo "Using ${cmd}"
	if [[ -d "${FILESDIR}/${cmd}" ]]; then
		${STOW} ${STOWARGS} --adopt ${cmd}
		${STOW} ${STOWARGS} -R ${cmd}
	fi
	if [[ -f "post/${cmd}" ]]; then
		(
			this_pwd="$PWD"
			cd "files/${cmd}"
			sh "${this_pwd}/post/${cmd}"
		)
	fi
done

echo ${uniques[@]} > ${USERC}
